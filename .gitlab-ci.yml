image: docker:latest

variables:
  DOCKER_IMAGE: docker:28.1.1-dind
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  TEST_TAG: "$IMAGE_NAME:testing"
  LATEST_TAG: "$IMAGE_NAME:latest"
  ROLLING_TAG: "$IMAGE_NAME:rolling"
  VERSION_TAG: "$IMAGE_NAME:$CI_COMMIT_TAG"
  DOCKER_TLS_CERTDIR: "/certs"

stages:
  - docker image build
  - docker image test
  - docker image rolling
  - docker image push registry
  - docker image test pull registry
  - generate release notes
  - update readme  
  - dockerhub update readme
  - release

.docker_template: &docker_template
  image: $DOCKER_IMAGE
  services:
    - $DOCKER_IMAGE
  tags:
    - dockerimage
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY

docker image build:
  <<: *docker_template
  stage: docker image build
  rules:
    - if: ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_TAG) && $ROLLING_BUILD != "true"
    - if: '$FORCE_TEST == "true"'
    - if: '$ROLLING_BUILD == "true"'
  script:
    - docker build -t $TEST_TAG -f Dockerfile .
    - docker push $TEST_TAG

docker image smoke test:
  <<: *docker_template
  stage: docker image test
  rules:
    - if: ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_TAG) && $ROLLING_BUILD != "true"
    - if: '$FORCE_TEST == "true"'
    - if: '$ROLLING_BUILD == "true"'
  script: docker run --rm --entrypoint sh $TEST_TAG -c 'apk info | grep msmtp && echo "msmtp available"'

docker create rolling image:
  <<: *docker_template
  stage: docker image rolling
  rules:
    - if: $ROLLING_BUILD == "true"
  script:
    - docker pull $TEST_TAG
    - docker tag $TEST_TAG $ROLLING_TAG
    - docker push $ROLLING_TAG

check new versions:
  <<: *docker_template
  stage: docker image test
  rules:
    - if: $ROLLING_BUILD == "true"
  before_script:
    - docker pull $TEST_TAG
    - docker run --rm --entrypoint cat $TEST_TAG /version.txt > current_version.txt
    - cat current_version.txt
    - echo "latest version in .version/version_latest.txt:"
    - cat .version/version_latest.txt
    - echo "current version in new image:"
  script:
    # if version is new send a mail
    - |
      NEW_VERSION_DETECTED=false

      # Parse current version
      while IFS=': ' read -r key value; do
        current_key=$(echo "$key" | tr -d '[:space:]')
        current_value=$(echo "$value" | tr -d '[:space:]')
        
        # Find corresponding key in version_latest.txt
        latest_value=$(grep "^$current_key:" .version/version_latest.txt | cut -d':' -f2- | tr -d '[:space:]')
        
        if [ "$current_value" != "$latest_value" ]; then
          echo "Version difference detected for $current_key:"
          echo "  Current: $current_value"
          echo "  Latest:  $latest_value"
          NEW_VERSION_DETECTED=true
        else
          echo "No change for $current_key: $current_value"
        fi
      done < current_version.txt

      if [ "$NEW_VERSION_DETECTED" = "true" ]; then
        echo "New version detected, sending mail..."
        docker run --rm \
        -e SMTP_SERVER=$SMTP_SERVER \
        -e SMTP_PORT=587 \
        -e SMTP_USER=$SMTP_USER \
        -e SMTP_PASS="$(echo $SMTP_PASS_BASE64 | base64 -d)" \
        -e FROM=$SMTP_USER \
        -e TO=$SMTP_TO \
        -e SUBJECT="New base alpine-mailutil images" \
        -e BODY="A new version of alpine-mailutil can be build: $(cat current_version.txt | tr '\n' ' '). The latest version in repository was: $(cat .version/version_latest.txt | tr '\n' ' ')" \
        $LATEST_TAG
      else
        echo "No new version detected, skipping mail."
      fi

docker image sendmail test:
  <<: *docker_template
  stage: docker image test
  rules:
    - if: ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_TAG) && $ROLLING_BUILD != "true"
    - if: '$FORCE_TEST == "true"'
  script:
    - >
      docker run --rm
      -e SMTP_SERVER=$SMTP_SERVER
      -e SMTP_PORT=587
      -e SMTP_USER=$SMTP_USER
      -e SMTP_PASS="$(echo $SMTP_PASS_BASE64 | base64 -d)"
      -e FROM=$SMTP_USER
      -e TO=$SMTP_TO
      -e SUBJECT="Testmail from alpine-mailutil"
      -e BODY="This is a test message with symbols üòäüëç‚ùå‚òëÔ∏è‚úÖ"
      $TEST_TAG

docker image sendmail from file test:
  <<: *docker_template
  stage: docker image test
  rules:
    - if: ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_TAG) && $ROLLING_BUILD != "true"
    - if: '$FORCE_TEST == "true"'
  script:
    - echo "This is a test message with symbols üòäüëç‚ùå‚òëÔ∏è‚úÖ" > body.txt
    - >
      docker run --rm
      -v "$CI_PROJECT_DIR/body.txt:/tmp/body.txt:ro"
      -e SMTP_SERVER=$SMTP_SERVER
      -e SMTP_PORT=587
      -e SMTP_USER=$SMTP_USER
      -e SMTP_PASS="$(echo $SMTP_PASS_BASE64 | base64 -d)"
      -e FROM=$SMTP_USER
      -e TO=$SMTP_TO
      -e SUBJECT="Testmail from alpine-mailutil"
      -e BODY_FILE="/tmp/body.txt"
      $TEST_TAG

generate release notes:
  stage: generate release notes
  <<: *docker_template
  rules:
    - if: ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_TAG) && $ROLLING_BUILD != "true"
    - if: '$FORCE_TEST == "true"'
  script:
    - docker pull $TEST_TAG
    - docker create --name extract-container $TEST_TAG
    - docker cp extract-container:/version.txt ./version.txt
    - docker rm extract-container
    - echo "### Image Versions" > release.md
    - echo "\`\`\`" >> release.md
    - cat version.txt >> release.md
    - echo "\`\`\`" >> release.md

    - echo "version.txt is as follows:"
    - cat version.txt
    - echo "release.md is as follows:"
    - cat release.md
  artifacts:
    paths:
      - version.txt
      - release.md

update readme with versions:
  stage: update readme
  <<: *docker_template
  needs:
    - job: generate release notes
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG
  before_script:
    - apk add --no-cache git
    - git config --global user.name "GitLab CI"
    - git config --global user.email "gitlab@hl-dev.de"
    - git config --global core.sshCommand 'ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no'
    - git remote set-url origin ssh://git@${CI_SERVER_SHELL_SSH_HOST}:${CI_SERVER_SHELL_SSH_PORT}/${CI_PROJECT_PATH}.git
    - mkdir -p ~/.ssh
    - cp ${DEPLOY_KEY} ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - git status
    - git fetch origin
  script:
    # Create formatted version block
    - git checkout main
    - git reset --hard origin/main

    - echo "### üß± Version ${CI_COMMIT_TAG}" > new_version_block.md
    - awk '{ print "- " $0 }' version.txt >> new_version_block.md
    - echo "" >> new_version_block.md

    # Insert after VERSION_START block
    - |
      awk '
      BEGIN { inserted=0 }
      {
      print
      if ($0 ~ /<!-- VERSION_START -->/ && !inserted) {
      while ((getline line < "new_version_block.md") > 0) print line
      inserted = 1
      }
      }' README.MD > README.new && mv README.new README.MD
    - cat README.MD
    # Commit and push changes
    - git add README.MD
    - >
      git commit -m "chore: update image versions in README for $CI_COMMIT_TAG"

    # save last version.txt to repository file
    - cp version.txt .version/version_latest.txt -f
    - git add .version/version_latest.txt
    - >
      git commit -m "chore: update version_latest.txt for $CI_COMMIT_TAG"
    - git push origin main -o ci.skip

docker image push registry:
  <<: *docker_template
  stage: docker image push registry
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - docker pull $TEST_TAG
    - docker tag $TEST_TAG $LATEST_TAG
    - docker push $LATEST_TAG
    - docker tag $TEST_TAG $VERSION_TAG
    - docker push $VERSION_TAG

docker image push dockerhub:
  <<: *docker_template
  stage: docker image push registry
  rules:
    - if: $CI_COMMIT_TAG
  before_script:
    - echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin
  script:
    - docker pull $TEST_TAG
    - docker pull $LATEST_TAG
    - docker tag $TEST_TAG $DOCKERHUB_USERNAME/mailutil-alpine:$CI_COMMIT_TAG
    - docker tag $TEST_TAG $DOCKERHUB_USERNAME/mailutil-alpine:latest
    - docker push $DOCKERHUB_USERNAME/mailutil-alpine:$CI_COMMIT_TAG
    - docker push $DOCKERHUB_USERNAME/mailutil-alpine:latest

docker image test pull registry:
  <<: *docker_template
  stage: docker image test pull registry
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - docker pull $LATEST_TAG
    - docker run --rm --entrypoint sh $LATEST_TAG -c 'echo "Pushed image works."'

dockerhub image test pull registry:
  <<: *docker_template
  stage: docker image test pull registry
  image: docker:latest
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - docker pull $DOCKERHUB_USERNAME/mailutil-alpine:latest
    - docker run --rm --entrypoint sh $DOCKERHUB_USERNAME/mailutil-alpine:latest -c 'echo "Pushed DockerHub image works."'

update dockerhub readme:
  stage: dockerhub update readme
  image: alpine:latest
  rules:
    - if: ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_TAG) && $ROLLING_BUILD != "true"
    - if: '$FORCE_TEST == "true"'
    - if: '$ROLLING_BUILD == "true"'
  before_script:
    - apk add --no-cache jq
    - jq --version
    - apk add --no-cache curl
    - curl --version
  script:
    - |
      TOKEN=$(curl -s -H "Content-Type: application/json" \
        -d "{\"username\": \"$DOCKERHUB_USERNAME\", \"password\": \"$DOCKERHUB_TOKEN\"}" \
        https://hub.docker.com/v2/users/login/ | jq -r .token)
    - |
      jq -Rs '{full_description: .}' README.MD > payload.json
    - |
      curl -X PATCH \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $TOKEN" \
        https://hub.docker.com/v2/repositories/$DOCKERHUB_USERNAME/mailutil-alpine/ \
        -d @payload.json

release job:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "Publishing release for tag $CI_COMMIT_TAG"
  release:
    tag_name: "$CI_COMMIT_TAG"
    description: "$(cat release.md)"
