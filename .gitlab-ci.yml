image: docker:latest

variables:
  DOCKER_IMAGE: docker:28.1.1-dind
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  TEST_TAG: "$IMAGE_NAME:testing"
  LATEST_TAG: "$IMAGE_NAME:latest"
  VERSION_TAG: "$IMAGE_NAME:$CI_COMMIT_TAG"
  DOCKER_TLS_CERTDIR: "/certs"

stages:
  - docker image build
  - docker image test
  - docker image push registry
  - update readme with versions
  - docker image test push registry
  - release

.docker_template: &docker_template
  image: $DOCKER_IMAGE
  services:
    - $DOCKER_IMAGE
  tags:
    - dockerimage
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY

docker image build:
  <<: *docker_template
  stage: docker image build
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_TAG
  script:
    - docker build -t $TEST_TAG -f Dockerfile .
    - docker push $TEST_TAG

docker image smoke test:
  <<: *docker_template
  stage: docker image test
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_TAG
  script: docker run --rm --entrypoint sh $TEST_TAG -c 'apk info | grep msmtp && echo "msmtp available"'

docker image sendmail test:
  <<: *docker_template
  stage: docker image test
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_TAG
  script:
    - >
      docker run --rm
      -e SMTP_SERVER=$SMTP_SERVER
      -e SMTP_PORT=587
      -e SMTP_USER=$SMTP_USER
      -e SMTP_PASS="$(echo $SMTP_PASS_BASE64 | base64 -d)"
      -e FROM=$SMTP_USER
      -e TO=$SMTP_TO
      -e SUBJECT="Testmail from alpine-mailutil"
      -e BODY="This message uses SMTP authentication."
      $TEST_TAG

docker image push registry:
  <<: *docker_template
  stage: docker image push registry
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - docker pull $TEST_TAG
    - docker tag $TEST_TAG $LATEST_TAG
    - docker push $LATEST_TAG
    - docker tag $TEST_TAG $VERSION_TAG
    - docker push $VERSION_TAG

docker image test push registry:
  <<: *docker_template
  stage: docker image test push registry
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - docker pull $LATEST_TAG
    - docker run --rm --entrypoint sh $LATEST_TAG -c 'echo "Pushed image works."'

generate release notes:
  stage: release
  image: $DOCKER_IMAGE
  services:
    - $DOCKER_IMAGE
  rules:
    - if: $CI_COMMIT_TAG
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
  script:
    - docker pull $VERSION_TAG
    - docker create --name extract-container $VERSION_TAG
    - docker cp extract-container:/version.txt ./version.txt
    - docker rm extract-container
    - echo "### Image Versions" > release.md
    - echo "\`\`\`" >> release.md
    - cat version.txt >> release.md
    - echo "\`\`\`" >> release.md
  artifacts:
    paths:
      - release.md

update readme with versions:
  stage: release
  image: gitlab-org/ci-cd/git:latest
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker pull $VERSION_TAG
    - docker create --name extract-container $VERSION_TAG
    - docker cp extract-container:/version.txt ./version.txt
    - docker rm extract-container

    # Format version content for README
    - echo "<!-- VERSION_START -->" > versions.md
    - awk '{ print "* " $0 }' version.txt >> versions.md
    - echo "<!-- VERSION_END -->" >> versions.md

    # Replace section in README.md
    - awk '
      BEGIN { p=1 }
      /<!-- VERSION_START -->/ { print; while (getline < "versions.md") print; p=0 }
      /<!-- VERSION_END -->/ { p=1; next }
      p' README.md > README.new && mv README.new README.md

    - git config --global user.name "$GITLAB_USER"
    - git config --global user.email "$GITLAB_USER@gitlab"
    - git checkout $CI_COMMIT_BRANCH || git checkout -b release-readme-update
    - git add README.md
    - >
      git commit -m "chore: update image versions in README for $CI_COMMIT_TAG" &&
      git push https://$GITLAB_USER:$GITLAB_TOKEN@gitlab.hl-dev.de/$CI_PROJECT_PATH.git HEAD:$CI_COMMIT_BRANCH

release job:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "Publishing release for tag $CI_COMMIT_TAG"
  release:
    tag_name: "$CI_COMMIT_TAG"
    description: "$(cat release.md)"
